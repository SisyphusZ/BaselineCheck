
# BaselineCheck使用说明

# 0.部署环境介绍
该程序是运行在linux环境中，不支持CentOS，推荐使用Ubuntu，或者树莓派的原生系统，在使用本程序前首先需要安装依赖程序，可以执行下面的命令安装依赖，记得安装之前需要把apt源换到国内
```shell
apt-get install clamav
apt-get install gawk
apt-get install expect
```

# 1.工作目录
  在任意目录下新建一个BaselineCheck目录，将所有文件拷贝到该目录下，这个目录只能为该程序**独占**，也就是在该目录下不可以存放除本程序文件外的其他任何文件，否则会造成文件的丢失。

# 2.配置文件说明
本程序的配置文件为
```plain text
hosts.txt config.conf
```
其中config.conf文件的格式为
```plain text
#车辆ID:恶意文件扫描路径
1:.
```
车辆ID表示该程序运行的车辆的ID，恶意文件扫描路径表示需要对哪个目录进行恶意文件扫描。建议不要从根目录开始扫描。如果从根目录开始扫描会导致程序的执行时间过长，可以对/tmp或者当前目录进行扫描。也可以对根目录进行扫描。

hosts.txt文件用来指定目标服务器，通过在该文件中配置目标服务器的IP地址，程序会自动将检测的结果提交给该文件中指定的服务器。该配置文件的格式说明如下
```plain text
#FLAG:IP:PORT:Username:password
1:192.168.1.194:22:root:123456
```
当FLAG的标志位为0，表示不开启上传功能，程序只会进行本地检测，不会上传结果。当FLAG的标志位为1，表示开启上传功能，程序会进行本地检测，并上传结果。

该程序是通过ssh进行文件传输的，所以需要保证目标服务器的ssh服务能够从树莓派访问到，端口使用ssh的端口号，如果ssh的默认端口没有修改就是22。如果存在路由NAT的情况，需要在路由器上配置端口转发。

# 3.执行
该程序执行前会检测运行环境是否安全，但是还是要强调一下
**不要在该程序的工作目录下放置任何重要文件，否则会被误删**
**不要在该程序的工作目录下放置任何重要文件，否则会被误删**
**不要在该程序的工作目录下放置任何重要文件，否则会被误删**
进入工作目录后执行脚本linuxcheck.sh脚本即可

```shell
./linuxcheck.sh
```
如果提示没有权限，一定要给该文件附加执行权限，我之前应该已经设置好了，如果没有执行权限可以执行下面的命令
```
chmod ugo+x linuxcheck.sh
```
执行过程中他会进行权限检测，如果提示权限不够，记得转换到root用户后在执行该脚本，root用户的密码和pi用户的密码一致。

如果打开了文件上传功能，结果会上传到目标服务器的tmp目录下。如果想要修改目标服务器的目录目录可以修改文件put.exp中的内容，找到下面的行
```shell
spawn scp -P $port 1_result.log 1_warning.log $username@$ipadd:/tmp/
```
将
```
/tmp/
```
修改为你需要的路径即可。

本程序执行后只会进行一次检查，如需要周期性检查需要将通过周期计划任务将该脚本设置为周期执行。推荐使用系统的例行任务而不要使用用户周期任务
## 3.1 系统例行任务配置方式
直接修改/etc/crontab文件中的内容，该文件详细说明可以百度，基本配置格式这里简单说明一下
```shell
分 时 日 月 周 用户 执行的命令
```
比如本程序在机器上的存放路径是
```plain text
/BaselineCheck/linuxcheck.sh
```
希望每30分钟执行一次该程序，可以配置为
```shell
*/30 * * * * root /BaselineCheck/linuxcheck.sh
```
## 3.2 用户周期任务配置方式
配置用户周期任务使用命令
```shell
crontab -u username -e
```
建议username使用root。该命令会打开一个文件，文件配置格式为
```shell
分 时 日 月 周 命令
```
配置方式可以参考上文

**无论使用哪种哪种方式配置，一定要使用命令的绝对路径**
**无论使用哪种哪种方式配置，一定要使用命令的绝对路径**
**无论使用哪种哪种方式配置，一定要使用命令的绝对路径**


# 4.日志格式说明

  程序执行后会产生两个日志，分别是\${id}_warning.log和\${id}_result.log，因为id被配置为了1，所以产生日志是

```
1_warning.log 1_result.log
```

其中1_warning.log记录了检查出来的风险项目，1_result.log是程序执行步骤的日志。你把两个都给她看。
  日志的第一行是

```
车辆ID:时间戳:NULL
```

以后的每一行都是

```
[风险等级]:事件说明:相应证据;
```

其中相应证据如果不存在的时候，日志显示的是

```
[风险等级]:事件说明:NULL;
```

如果有相应的证据，日志则会显示

```
[风险等级]:事件说明:
相应证据;
```

证据内容另起一行。

需要说明的一点是日志是直接进行追加的，也就说下一次的检测结果是直接写在上一次检测结果后面的，下面是提供一种文件解析的方案用于参考
```plain text
1.首次读取文件的时候，将文件内容读取后用分号(;)切割成一段一段的
2.将第一段内容的使用冒号切分成一片一片的
3.提取中其中的车辆ID和时间戳信息，根据车辆ID将其与对应的车辆关联，需要使用时间戳可以使用时间戳
4.将后面的段内容使用冒号(:)切分成一片一片的，并将解析结果保存在数据库中，并进行展示
5.同时需要记录下该时间戳对应的文件偏移位
6.下次读取该文件的时候直接将文件指针偏移到之前记录的偏移位后，重复上面的操作
```
你可以不使用数据库每次将文件都从头到位重新解析一次。可以重点展示1_warning.log的内容，还有一个clam.log日志文件是用来记录恶意文件扫描的过程的，在进行展示的时候不需要关注该文件，该文件中的重要内容已经被提取出来放在1_warning.log中了。

需要补充说明的一点是，本程序生成的日志是中文，需要将树莓派配置成中文环境，否则会出现乱码，陈浩的树莓派已经配置完毕，可以直接使用。

# 5.补充说明
  如果要查看该程序对异常情况的检测，可以参考下面的命令
## 3.1 网卡工作模式修改
```shell
ifconfig 网卡名 promisc		#设置混杂模式
ifconfig 网卡名 -promisc	  #取消混杂模式
```
推荐你修改lo网卡，也就是执行命令
```shell
ifconfig 网卡名 promisc
```
记得看到检测效果后一定要取消混杂模式

## 3.2 周期计划任务(定时任务)
  以root用户创建如下的周期计划任务，运行下面的命令
```shell
crontab -e
```
然后在打开的文件中输入下面的内容
```
* * * * 1 chmod ugo+x test.txt
```
然后修改文件
```shell
/etc/cron*/*
```
或者
```shell
/var/spool/cron/*
```
上面两个文件中任意选一个即可，\*表示通配，添加下面的内容
```shell
* * * * 1 chmod ugo+x test.txt
```

## 3.3 公钥与私钥文件
  用ssh的公钥和私钥文件给他演示一下就可以了，使用下面的命令创建
```shell
ssh-keygen -t rsa
```
执行效果
```
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa):这里输入/root/.ssh/
Enter passphrase (empty for no passphrase): 这里输入密码，随便你
Enter same passphrase again:这里重复输入密码，随便你
Your identification has been saved in /home/fdipzone/.ssh/id_rsa.
Your public key has been saved in /home/fdipzone/.ssh/id_rsa.pub.
The key fingerprint is:
f2:76:c3:6b:26:10:14:fc:43:e0:0c:4d:51:c9:a2:b0 fdipzone@ubuntu
The key's randomart image is:
+--[ RSA 2048]----+
|    .+=*..       |
|  .  += +        |
|   o oo+         |
|  E . . o        |
|      ..S.       |
|      .o .       |
|       .o +      |
|       ...oo     |
|         +.      |
+-----------------+
```
检测完毕后记得删除

## 3.4 敏感文件权限
  会检测的敏感文件
```shell
/etc、/etc/shadow、/etc/passwd、/etc/group、/etc/securetty、/etc/services
```
只需要把上面文件的权限都修改为777
```
chmod 777 文件名
```
如果他要看的话你就改，不看就不改，改了以后记得改回来，我的程序里面会推荐应该配置的权限可以在日志中查看，你可以参考，或者你记住原来的权限。参考的权限如下

| /etc | /etc/shadow | /etc/passwd | /etc/group | /etc/securetty | /etc/services |
| ---- | ----------- | ----------- | ---------- | -------------- | ------------- |
| 750  | 600         | 644         | 644        | 600            | 644           |


